-- Minimal ESP (No GUI, Maximum Stealth)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

local espCache = {}

local function createESP(plr)
    if plr == player then return end
    if espCache[plr] then return end
    
    local drawings = {
        name = Drawing.new("Text"),
        distance = Drawing.new("Text"),
        health = Drawing.new("Text"),
        box = Drawing.new("Square"),
    }
    
    -- Configure text
    drawings.name.Size = 14
    drawings.name.Center = true
    drawings.name.Outline = true
    drawings.name.Color = Color3.new(1, 1, 1)
    
    drawings.distance.Size = 12
    drawings.distance.Center = true
    drawings.distance.Outline = true
    drawings.distance.Color = Color3.fromRGB(200, 200, 200)
    
    drawings.health.Size = 12
    drawings.health.Center = true
    drawings.health.Outline = true
    drawings.health.Color = Color3.fromRGB(0, 1, 0)
    
    -- Configure box
    drawings.box.Thickness = 2
    drawings.box.Filled = false
    drawings.box.Color = Color3.fromRGB(255, 0, 0)
    
    espCache[plr] = drawings
end

local function removeESP(plr)
    if not espCache[plr] then return end
    
    for _, drawing in pairs(espCache[plr]) do
        drawing:Remove()
    end
    
    espCache[plr] = nil
end

local function updateESP()
    for plr, drawings in pairs(espCache) do
        local char = plr.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        local head = char and char:FindFirstChild("Head")
        local humanoid = char and char:FindFirstChildOfClass("Humanoid")
        
        if not root or not head or not humanoid or humanoid.Health <= 0 then
            drawings.name.Visible = false
            drawings.distance.Visible = false
            drawings.health.Visible = false
            drawings.box.Visible = false
            continue
        end
        
        local rootPos, onScreen = camera:WorldToViewportPoint(root.Position)
        local headPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
        local legPos = camera:WorldToViewportPoint(root.Position - Vector3.new(0, 3, 0))
        
        if not onScreen then
            drawings.name.Visible = false
            drawings.distance.Visible = false
            drawings.health.Visible = false
            drawings.box.Visible = false
            continue
        end
        
        local distance = (root.Position - camera.CFrame.Position).Magnitude
        local sizeFactor = 1 / (distance / 10)
        
        -- Update name
        drawings.name.Text = plr.Name
        drawings.name.Position = Vector2.new(rootPos.X, headPos.Y - 10)
        drawings.name.Visible = true
        
        -- Update distance
        drawings.distance.Text = math.floor(distance) .. "m"
        drawings.distance.Position = Vector2.new(rootPos.X, headPos.Y + 5)
        drawings.distance.Visible = true
        
        -- Update health
        local healthPercent = math.floor((humanoid.Health / humanoid.MaxHealth) * 100)
        drawings.health.Text = healthPercent .. "%"
        drawings.health.Position = Vector2.new(rootPos.X, headPos.Y + 20)
        
        if healthPercent > 75 then
            drawings.health.Color = Color3.fromRGB(0, 255, 0)
        elseif healthPercent > 40 then
            drawings.health.Color = Color3.fromRGB(255, 255, 0)
        else
            drawings.health.Color = Color3.fromRGB(255, 0, 0)
        end
        drawings.health.Visible = true
        
        -- Update box
        local boxHeight = math.abs(headPos.Y - legPos.Y)
        local boxWidth = boxHeight / 2
        
        drawings.box.Size = Vector2.new(boxWidth, boxHeight)
        drawings.box.Position = Vector2.new(rootPos.X - boxWidth / 2, headPos.Y)
        drawings.box.Visible = true
    end
end

-- Player management
for _, plr in ipairs(Players:GetPlayers()) do
    if plr ~= player then
        createESP(plr)
    end
end

Players.PlayerAdded:Connect(function(plr)
    if plr ~= player then
        createESP(plr)
    end
end)

Players.PlayerRemoving:Connect(removeESP)

-- Update loop
RunService.RenderStepped:Connect(updateESP)

print("ESP loaded")
